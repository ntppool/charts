---
kind: pipeline
type: kubernetes
name: default

steps:
- name: fetch
  image: alpine/git
  commands:
  - git fetch --tags

#- name: list-changed
#  image: quay.io/helmpack/chart-testing:v3.0.0-rc.1
#  environment:
#    GIT_TRACE: "1"
#  commands:
#  - apk add --update git make
#  - ls -la
#  - cat .git/config
#  - ct list-changed --config ct.yaml

#- name: lint
#  image: harbor.ntppool.org/ntppool/chart-testing:v3.0.1-dev.0
#  environment:
#    GIT_TRACE: "1"
#  commands:
#  - apk add --update git make
#  - env
#  - pwd
#  - ls -l
#  - ct lint --debug

- name: build
  image: alpine/helm:3.12.0
  environment:
    HELM_PASSWORD:
      from_secret: helm_password
    HELM_USERNAME:
      from_secret: helm_username
    HELM_URL:
      from_secret: helm_repo_url
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY
    AWS_ENDPOINT:
      from_secret: AWS_ENDPOINT
    HELM_S3_REGION:
      value: "east"

  commands:
  - apk add --update make git perl
  - helm plugin install https://github.com/hypnoglow/helm-s3.git
  - make publish
  when:
    branch:
      include:
      - main
---
kind: signature
hmac: 21fa0beee5284b8fd6b9b7e532d694fddfef081c68ce245c4c26256fb8fd335d

...
